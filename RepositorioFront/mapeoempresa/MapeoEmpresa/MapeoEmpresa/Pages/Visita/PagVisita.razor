@page "/pagVisita"
@attribute [Authorize(Roles = "EMPLEADO", Policy = "PoliticaRealizarVisita")]

@inject NavigationManager NavigationManager
@using EntidadesNegocio.EntidadesDto;
@inject RegistroEvidenciaService RegistroService;
@inject VisitaService VisitaService;


<PageTitle>Visita</PageTitle>
<div class="flex-container">
    <button class="btn" @onclick="Retroceder">
        <i class="fas fa-circle-chevron-left"></i>
    </button>
    <h1><b>Información visita ID @visita.id</b></h1>
</div>

<div class="col-lg-10 contact-form__wrapper pt-2 contenedor-bloque">
    <div class="row">
        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="fechaInicio">Fecha de inicio: </label>
                <input type="text" class="form-control" id="fechaInicio" value="@visita.fechaInicio" readonly>
            </div>
        </div>

        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="fechaFinaliza">Fecha de finalización: </label>
                <input type="text" class="form-control" id="fechaFinaliza" value="@visita.fechaFinaliza" readonly>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="fechaCreacion">Fecha de creación: </label>
                <input type="text" class="form-control" id="fechaCreacion" value="@visita.fechaCreacion" readonly>
            </div>
        </div>

        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="cantidadDias">Cantidad de días: </label>
                <input type="text" class="form-control" id="cantidadDias" value="@visita.cantidadDias" readonly>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="contactoEmpresa">Contacto de empresa: </label>
                <input type="text" class="form-control" id="contactoEmpresa" value="@visita.contactoEmpresa" readonly>
            </div>
        </div>

        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="empresaCliente">Nombre empresa cliente: </label>
                <input type="text" class="form-control" id="empresaCliente" value="@visita.empresaCliente" readonly>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="sedeCliente">ID sede cliente: </label>
                <input type="text" class="form-control" id="sedeCliente" value="@visita.sedeCliente" readonly>
            </div>
        </div>

        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="plantaCliente">Nombre planta cliente: </label>
                <input type="text" class="form-control" id="plantaCliente" value="@visita.plantaCliente" readonly>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="estado">Estado: </label>
                <input type="text" class="form-control" id="estado" value="@visita.estado" readonly>
            </div>
        </div>

        <div class="col-sm-6 mb-3">
            <div class="form-group">
                <label for="asociada">Venta asociada: </label>
                <input type="text" class="form-control" id="asociada" value="@(visita.idVentaAsociada == 0 ? "Pendiente" : visita.idVentaAsociada)" readonly>
            </div>
        </div>

        <div class="col-sm-12 mb-3">
            <button class="btn btn-success" @onclick="ConfirmarOperacion">
                <i class="oi oi-circle-check"></i> Finalizar Visita
            </button>
        </div>

    </div>
    

</div>

<div class="pt-2">
    @foreach (var item in types)
    {
        if (Array.IndexOf(types, item) == selected)
        {
            <button class="btn btn-secondary">@item.Name</button>
        }
        else
        {
            <button class="btn btn-outline-secondary" @onclick="() => selected = Array.IndexOf(types, item)">@item.Name</button>
        }
    }
</div>

@if (modalConfirmacion)
{
    <div class="modal" tabindex="-1" style="display:block">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar operación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick=CerrarModal></button>
                </div>
                <div class="modal-body">
                    <p>¿Esta seguro que desea finalizar la visita? Recuerde que no podrá hacer mas cambios si acepta.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal" @onclick=CerrarModal>Cancelar</button>
                    <button type="button" class="btn btn-success" @onclick=FinalizarVisita>Finalizar</button>
                </div>
            </div>
        </div>
    </div>
}

<div class="contenedor-bloque p-4 ">
    @GetRenderFragment(types[selected])
</div>
<br />

@code {
    VisitaDTO visita = new VisitaDTO();
    int selected;
    ComponentBase[] components = { new CargarEvidencia(), new ListarEvidencia(), new HistorialVentas(), new CondicionesOperativas()};
    Type[] types => components.Select(c => c.GetType()).ToArray();
    private bool modalConfirmacion = false;

    RenderFragment GetRenderFragment(Type type)
    {
        RenderFragment renderFragment = renderTreeBuilder =>
        {
            renderTreeBuilder.OpenComponent(0, type);
            renderTreeBuilder.CloseComponent();
        };
        return renderFragment;
    }

    private void Retroceder()
    {
        NavigationManager.NavigateTo("/gestionarVisitas");
    }

    protected override void OnInitialized()
    {
        visita = RegistroService.VisitaSeleccionada;
    }

    private async Task FinalizarVisita()
    {
        await VisitaService.FinalizarVisita(RegistroService.VisitaSeleccionada.id);
        modalConfirmacion = false;
        NavigationManager.NavigateTo("/gestionarVisitas");
    }

    private void ConfirmarOperacion()
    {
        modalConfirmacion = true;
    }

    private void CerrarModal()
    {
        modalConfirmacion = false;
    }
}

